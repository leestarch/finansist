import{r as u,k as O,P as D,o as f,c as G,w as d,m as x,N as c,b as o,a as s,d as j,e as q,n as H,q as J,s as F,l as z,v as K,t as g,F as W,f as X,g as Z}from"./app-6990ba06.js";import{Q as ee,d as te}from"./QDate-378e0ba7.js";import{Q as ae,a as b}from"./QSelect-39cf87be.js";import{Q as oe,a as le}from"./QTable-adad826a.js";import{Q as se}from"./QForm-ce3dfc0a.js";import{Q as ne}from"./QPage-85c522ef.js";const re={class:"row q-mx-auto bg-white col-10 col-sm-8"},ie={class:"row items-center justify-between"},ue={class:"col-9"},de={class:"row items-center justify-between q-mt-sm"},ce={class:"col-4"},me={class:"col-5 text-right"},pe={class:"row items-center justify-between q-mt-sm"},ve={class:"col-9 full-height"},fe={class:"row items-center justify-between q-mt-sm"},ge={class:"col-9 full-height"},be={class:"row items-center justify-between q-mt-sm"},ye={class:"col-9 full-height"},we={class:"row items-center justify-between q-mt-sm"},_e={class:"col-9"},Ve={class:"row items-center justify-between q-mt-sm"},he={class:"col-9"},Ce={class:"row items-center justify-between q-mt-sm"},xe={class:"col-9"},qe={key:0},Fe={key:1,style:{"min-width":"65px"}},ze={class:"row"},Pe={class:"row col-3 justify-end"},Qe={class:"row col-3 justify-end"},je={key:0,class:"row justify-between"},Ue={class:"text-red-8 row col-8 justify-center"},ke={class:"col-4 row justify-center"},Te={__name:"Create",setup(De){const P=u([]),y=u([]),U=u([]),w=u(!1),m=u([]),_=u({message:"",difference:""}),a=u({pizzeria:null,sber_amountRub:"",sber_paymentPurpose:"",is_completed:!1,date_at:"",direction:null,contractorPayer:null,contractorPayee:null,categories:[]}),Q=u(""),v=u(!1),R=l=>{a.value.date_at=l,Q.value=te.formatDate(l,"DD.MM.YYYY"),v.value=!1},I=l=>{const n=l.replace(/,/g,".").replace(/[^\d.-]/g,"");if(/^-?\d*\.?\d*$/.test(n)){const r=parseFloat(n);a.value.amount=isNaN(r)?"":r}else a.value.amount=""},N=()=>{I(a.value.amount)},M=async()=>{try{const l=await x.get("/api/pizzerias");U.value=l.data.data}catch{c.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},Y=async()=>{try{const l=await x.get("/api/categories");P.value=l.data.data,y.value=l.data.data}catch{c.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},B=async(l,e="")=>{try{const n=await x.get("/api/contractors",{params:{q:l||"",id:e}});m.value=n.data.data}catch{c.create({message:"Ошибка получения контрагентов",color:"red",timeout:2e3})}finally{w.value=!1}},k=async(l,e)=>{l.length>4?(w.value=!0,await B(l),e(()=>m.value)):(m.value=[],e(()=>m.value))},T=async()=>{var e,n,t,r,i,V,h;const l=a.value.categories.reduce((p,C)=>p+(parseFloat(C.amount)||0),0);if(a.value.categories.length&&l!==parseFloat(a.value.sber_amountRub)){c.create({message:"Сумма категорий не равна сумме операции",color:"red"});return}try{a.value.pizzeria_id=(n=(e=a.value)==null?void 0:e.pizzeria)==null?void 0:n.id;const p=await x.post("/api/operations",{...a.value,payer_contractor_id:(r=(t=a.value)==null?void 0:t.contractorPayer)==null?void 0:r.id,payee_contractor_id:(V=(i=a.value)==null?void 0:i.contractorPayee)==null?void 0:V.id,sber_paymentPurpose:a.value.sber_paymentPurpose,sber_direction:(h=a.value.direction)==null?void 0:h.value,categories:a.value.categories.map(C=>({id:C.category.id,sber_amountRub:C.amount}))});p.data.success&&(c.create({message:"Операция успешно создана",color:"positive"}),a.value={pizzeria:null,sber_amountRub:"",description:"",is_completed:!1,date:"",contractor:null,categories:[]}),p.data.success||c.create({message:p.data.message,color:"red"})}catch{c.create({message:"Ошибка отправки данных",color:"red"})}},E=(l,e)=>{const n=a.value.categories.reduce((V,h)=>V+(parseFloat(h.amount)||0),0),t=parseFloat(a.value.sber_amountRub)-n,r=parseFloat(e.row.amount)/parseFloat(a.value.sber_amountRub)*100;e.row.percent=r.toFixed(2);let i="";t<n?i="Уменьшите сумму на: ":t>n&&(i="Увеличьте сумму на: "),_.value={message:i,difference:Math.abs(t)}},L=(l,e)=>{if(l==="")e(()=>{y.value=[...P.value]});else{const n=l.toLowerCase();e(()=>{y.value=P.value.filter(t=>t.name.toLowerCase().includes(n))})}};function S(l){console.log(l.id),a.value.categories=a.value.categories.filter(e=>(e==null?void 0:e.category)!==null)}const $=u([{name:"category",label:"Категория",align:"left"},{name:"amount",label:"Сумма",align:"left",style:"width: 100px"},{name:"percent",label:"Доля",align:"left",width:"50px"}]),A=()=>{a.value.categories.push({category:"",amount:0,percent:0})};return O(()=>{D.show(),M(),Y(),D.hide()}),(l,e)=>(f(),G(ne,{class:"row shadow-3 bg-grey-2"},{default:d(()=>[o("div",re,[s(Z,{class:"bg-white q-px-xl blue col-12"},{default:d(()=>[e[21]||(e[21]=o("div",{class:"text-h4 q-mt-md"}," Создание операции ",-1)),s(se,{class:"q-mt-xl",onSubmit:j(T,["prevent"])},{default:d(()=>{var n;return[o("div",ie,[e[12]||(e[12]=o("div",{class:"col-2 full-height"}," Сумма: ",-1)),o("div",ue,[s(q,{dense:"",outlined:"",modelValue:a.value.sber_amountRub,"onUpdate:modelValue":e[0]||(e[0]=t=>a.value.sber_amountRub=t),label:"Сумма",type:"number",required:"",onInput:N},null,8,["modelValue"])])]),o("div",de,[e[13]||(e[13]=o("div",{class:"col-3 full-height"}," Дата: ",-1)),o("div",ce,[s(q,{class:"col-2 q-px-sm q-mt-sm",dense:"",outlined:"",filled:"",modelValue:Q.value,"onUpdate:modelValue":e[4]||(e[4]=t=>Q.value=t),label:"Дата",readonly:"",onClick:e[5]||(e[5]=j(t=>v.value=!0,["stop"]))},{append:d(()=>[s(H,{name:"event",onClick:e[1]||(e[1]=j(t=>v.value=!0,["stop"]))})]),default:d(()=>[s(ae,{modelValue:v.value,"onUpdate:modelValue":e[3]||(e[3]=t=>v.value=t),anchor:"bottom left",self:"top left"},{default:d(()=>[s(ee,{modelValue:a.value.date_at,"onUpdate:modelValue":[e[2]||(e[2]=t=>a.value.date_at=t),R],mask:"YYYY-MM-DD"},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])]),o("div",me,[s(J,{dense:"",outlined:"",modelValue:a.value.is_completed,"onUpdate:modelValue":e[6]||(e[6]=t=>a.value.is_completed=t),label:"Подтвердить операцию"},null,8,["modelValue"])])]),o("div",pe,[e[14]||(e[14]=o("div",{class:"col-3 full-height"}," Пиццерия: ",-1)),o("div",ve,[s(b,{class:"col-3",dense:"",clearable:"",outlined:"",filled:"",modelValue:a.value.pizzeria,"onUpdate:modelValue":e[7]||(e[7]=t=>a.value.pizzeria=t),options:U.value,label:"Пиццерия","option-value":"id","option-label":"name",required:""},null,8,["modelValue","options"])])]),o("div",fe,[e[15]||(e[15]=o("div",{class:"col-3 full-height"}," Контрагент (payer): ",-1)),o("div",ge,[s(b,{class:"col-6",dense:"",outlined:"",filled:"",label:"Контрагент",modelValue:a.value.contractorPayer,"onUpdate:modelValue":e[8]||(e[8]=t=>a.value.contractorPayer=t),options:m.value,"use-input":"",clearable:"","option-label":"name",onFilter:k,loading:w.value},null,8,["modelValue","options","loading"])])]),o("div",be,[e[16]||(e[16]=o("div",{class:"col-3 full-height"}," Контрагент (payee): ",-1)),o("div",ye,[s(b,{class:"col-6",dense:"",outlined:"",filled:"",label:"Контрагент",modelValue:a.value.contractorPayee,"onUpdate:modelValue":e[9]||(e[9]=t=>a.value.contractorPayee=t),options:m.value,"use-input":"",clearable:"","option-label":"name",onFilter:k,loading:w.value},null,8,["modelValue","options","loading"])])]),o("div",we,[e[17]||(e[17]=o("div",{class:"col-2 full-height"}," Direction: ",-1)),o("div",_e,[s(b,{dense:"",outlined:"",required:"",filled:"",label:"Тип операции",modelValue:a.value.direction,"onUpdate:modelValue":e[10]||(e[10]=t=>a.value.direction=t),options:[{label:"Поступление (debit)",value:"DEBIT"},{label:"Выплата (credit)",value:"CREDIT"}]},null,8,["modelValue"])])]),o("div",Ve,[e[18]||(e[18]=o("div",{class:"col-2 full-height"}," Назначение: ",-1)),o("div",he,[s(q,{type:"textarea",dense:"",outlined:"",modelValue:a.value.sber_paymentPurpose,"onUpdate:modelValue":e[11]||(e[11]=t=>a.value.sber_paymentPurpose=t),label:"Назначение",required:""},null,8,["modelValue"])])]),o("div",Ce,[e[20]||(e[20]=o("div",{class:"col-3 full-height"}," Категории: ",-1)),o("div",xe,[s(oe,{rows:a.value.categories,columns:$.value,flat:"",bordered:"",dense:"","hide-bottom":""},{"body-cell":d(t=>[s(le,{item:t},{default:d(()=>{var r;return[t.col.name==="category"?(f(),F("div",qe,[s(b,{dense:"",flat:"",modelValue:t.row.category,"onUpdate:modelValue":i=>t.row.category=i,options:y.value,"option-label":"name",clearable:"",borderless:"","use-input":"",onFilter:L,onClear:S},null,8,["modelValue","onUpdate:modelValue","options"])])):z("",!0),t.col.name==="amount"?(f(),F("div",Fe,[s(q,{onChange:i=>E(i,t),flat:"",borderless:"",modelValue:t.row.amount,"onUpdate:modelValue":i=>t.row.amount=i,dense:"",type:"number"},null,8,["onChange","modelValue","onUpdate:modelValue"])])):z("",!0),t.col.name==="percent"?(f(),F(W,{key:2},[K(g((r=t.row)==null?void 0:r.percent)+"% ",1)],64)):z("",!0)]}),_:2},1032,["item"])]),_:1},8,["rows","columns"]),o("div",ze,[o("div",{class:"row justify-between col-6"},[o("p",{onClick:A,class:"cursor-pointer text-blue-9"}," Добавить... "),e[19]||(e[19]=o("p",null," Итого: ",-1))]),o("div",Pe,[o("p",null,g(a.value.categories.reduce((t,r)=>t+(parseFloat(r.amount)||0),0)),1)]),o("div",Qe,[o("p",null,g((a.value.categories.reduce((t,r)=>t+(parseFloat(r.amount)||0),0)/a.value.sber_amountRub*100).toFixed(2))+"% ",1)])]),(n=_.value)!=null&&n.message?(f(),F("div",je,[o("div",Ue,g(_.value.message),1),o("div",ke,g(_.value.difference),1)])):z("",!0)])]),s(X,{class:"q-mt-md",label:"Сохранить",type:"submit",color:"primary"})]}),_:1})]),_:1})])]),_:1}))}};export{Te as default};
