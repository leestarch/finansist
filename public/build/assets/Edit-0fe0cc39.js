import{u as T,r as u,k as $,P as b,o as m,c as A,w as p,m as v,N as i,b as s,a as n,d as O,e as _,q as G,s as y,l as w,v as H,t as g,F as J,f as K,g as W}from"./app-6990ba06.js";import{a as z}from"./QSelect-39cf87be.js";import{Q as X,a as Y}from"./QTable-adad826a.js";import{Q as Z}from"./QForm-ce3dfc0a.js";import{Q as ee}from"./QPage-85c522ef.js";import{o as ae}from"./format-04e7afb3.js";const te={class:"row q-mx-auto bg-white col-10 col-sm-8"},oe={class:"row items-center justify-between"},se={class:"col-9"},le={class:"row items-center justify-between q-mt-sm"},re={class:"col-4"},ne={class:"col-5 text-right"},ie={class:"row items-center justify-between q-mt-sm"},ue={class:"col-9 full-height"},de={class:"row items-center justify-between q-mt-sm"},ce={class:"col-9 full-height"},me={class:"row items-center justify-between q-mt-sm"},pe={class:"col-9"},ve={class:"row items-center justify-between q-mt-sm"},ge={class:"col-9"},fe={key:0},be={key:1,style:{"min-width":"65px"}},_e={class:"row"},ye={class:"row col-3 justify-end"},we={class:"row col-3 justify-end"},he={key:0,class:"row justify-between"},Ve={class:"text-red-8 row col-8 justify-center"},Ce={class:"col-4 row justify-center"},Ne={__name:"Edit",setup(xe){const F=T().params.id,h=u([]),V=u(!1),d=u([]),C=u([]),f=u([]),c=u({message:"",difference:0}),t=u({pizzeria:null,sber_amountRub:"",description:"",is_completed:!1,date:"",contractor:null,categories:[],type:null}),R=l=>{const e=l.replace(/,/g,".").replace(/[^\d.-]/g,"");if(/^-?\d*\.?\d*$/.test(e)){const r=parseFloat(e);t.value.amount=isNaN(r)?"":r}else t.value.amount=""},q=()=>{R(t.value.amount)},j=async()=>{var l,a;try{const e=await v.get(`/api/operations/${F}`,{params:{include:"payeeContractor,categories"}});t.value.sber_amountRub=e.data.data.sber_amountRub,t.value.date=ae(new Date((a=(l=e.data)==null?void 0:l.data)==null?void 0:a.date_at),"yyyy-MM-dd"),t.value.is_completed=e.data.data.is_completed,t.value.pizzeria=h.value.find(o=>o.id===e.data.data.pizzeria_id),t.value.contractor=e.data.data.payee_contractor,t.value.description=e.data.data.sber_paymentPurpose,t.value.categories=e.data.data.categories.map(o=>({category:{id:o.id,name:o.name},amount:e.data.data.categories.length>1?o.sber_amountRub:t.value.sber_amountRub,percent:e.data.data.categories.length>1?(o.sber_amountRub/t.value.sber_amountRub*100).toFixed(2):100}))}catch(e){console.log(e),i.create({message:"Ошибка получения данных операции",color:"red"})}},Q=async()=>{try{const l=await v.get("/api/pizzerias");h.value=l.data.data}catch{i.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},k=async()=>{try{const l=await v.get("/api/categories",{params:{full_list:!0}});C.value=l.data.data,f.value=l.data.data}catch{i.create({message:"Ошибка получения данных",color:"red",timeout:2e3})}},N=async(l,a="")=>{try{const e=await v.get("/api/contractors",{params:{q:l||"",id:a}});d.value=e.data.data}catch{i.create({message:"Ошибка получения контрагентов",color:"red",timeout:2e3})}finally{V.value=!1}},U=async(l,a)=>{l.length>4?(V.value=!0,await N(l),a(()=>d.value)):(d.value=[],a(()=>d.value))},I=async()=>{var a,e;if(c.value.difference!==0){i.create({message:"Сумма категорий не равна сумме операции",color:"red"});return}if(t.value.categories.reduce((o,r)=>o+(parseFloat(r.amount)||0),0)!==parseFloat(t.value.sber_amountRub)){i.create({message:"Сумма категорий не равна сумме операции",color:"red"});return}b.show();try{const o=await v.put(`/api/operations/${F}`,{pizzeria_id:t.value.pizzeria.id,date_at:t.value.date,is_completed:t.value.is_completed,payee_contractor_id:t.value.contractor.id,sber_paymentPurpose:t.value.description,sber_amountRub:t.value.sber_amountRub,categories:t.value.categories.map(r=>({id:r.category.id,sber_amountRub:r==null?void 0:r.amount}))});(a=o==null?void 0:o.data)!=null&&a.success&&i.create({message:"Данные успешно обновлены",color:"green"}),o.data.success||i.create({message:(e=o==null?void 0:o.data)==null?void 0:e.message,color:"red"})}catch(o){console.log(o),i.create({message:"Проверьте правильность заполнения полей",color:"red"})}b.hide()},P=(l,a)=>{const e=t.value.categories.reduce((L,S)=>L+(parseFloat(S.amount)||0),0),o=parseFloat(t.value.sber_amountRub)-e,r=parseFloat(a.row.amount)/parseFloat(t.value.sber_amountRub)*100;a.row.percent=r.toFixed(2);let x="";o<e?x="Уменьшите сумму на: ":o>e&&(x="Увеличьте сумму на: "),c.value={message:x,difference:Math.abs(o)}},B=u([{name:"category",label:"Категория",align:"left"},{name:"amount",label:"Сумма",align:"left",style:"width: 100px"},{name:"percent",label:"Доля",align:"left",width:"50px"}]),M=()=>{t.value.categories.push({category:"",amount:0,percent:0})},D=(l,a)=>{if(l==="")a(()=>{f.value=[...C.value]});else{const e=l.toLowerCase();a(()=>{f.value=C.value.filter(o=>o.name.toLowerCase().includes(e))})}};function E(l){console.log(l.id),t.value.categories=t.value.categories.filter(a=>(a==null?void 0:a.category)!==null)}return $(()=>{b.show(),Q(),k(),j(),b.hide()}),(l,a)=>(m(),A(ee,{class:"row shadow-3 bg-grey-2"},{default:p(()=>[s("div",te,[n(W,{class:"bg-white q-px-xl blue col-12"},{default:p(()=>[a[13]||(a[13]=s("div",{class:"text-h4 q-mt-md"}," Редактирование операции ",-1)),n(Z,{class:"q-mt-xl",onSubmit:O(I,["prevent"])},{default:p(()=>[s("div",oe,[a[6]||(a[6]=s("div",{class:"col-2 full-height"}," Сумма: ",-1)),s("div",se,[n(_,{dense:"",outlined:"",modelValue:t.value.sber_amountRub,"onUpdate:modelValue":a[0]||(a[0]=e=>t.value.sber_amountRub=e),label:"Сумма",type:"number",required:"",onInput:q},null,8,["modelValue"])])]),s("div",le,[a[7]||(a[7]=s("div",{class:"col-3 full-height"}," Дата: ",-1)),s("div",re,[n(_,{dense:"",outlined:"",modelValue:t.value.date,"onUpdate:modelValue":a[1]||(a[1]=e=>t.value.date=e),label:"Date",type:"date",required:""},null,8,["modelValue"])]),s("div",ne,[n(G,{dense:"",outlined:"",modelValue:t.value.is_completed,"onUpdate:modelValue":a[2]||(a[2]=e=>t.value.is_completed=e),label:"Подтвердить операцию"},null,8,["modelValue"])])]),s("div",ie,[a[8]||(a[8]=s("div",{class:"col-3 full-height"}," Пиццерия: ",-1)),s("div",ue,[n(z,{class:"col-3",dense:"",clearable:"",outlined:"",filled:"",modelValue:t.value.pizzeria,"onUpdate:modelValue":a[3]||(a[3]=e=>t.value.pizzeria=e),options:h.value,label:"Пиццерия","option-value":"id","option-label":"name"},null,8,["modelValue","options"])])]),s("div",de,[a[9]||(a[9]=s("div",{class:"col-3 full-height"}," Контрагент: ",-1)),s("div",ce,[n(z,{class:"col-6",dense:"",outlined:"",filled:"",label:"Контрагент",modelValue:t.value.contractor,"onUpdate:modelValue":a[4]||(a[4]=e=>t.value.contractor=e),options:d.value,"use-input":"",clearable:"","option-label":"name",onFilter:U,loading:V.value},null,8,["modelValue","options","loading"])])]),s("div",me,[a[10]||(a[10]=s("div",{class:"col-2 full-height"}," Назначение: ",-1)),s("div",pe,[n(_,{type:"textarea",dense:"",outlined:"",modelValue:t.value.description,"onUpdate:modelValue":a[5]||(a[5]=e=>t.value.description=e),label:"Назначение",required:""},null,8,["modelValue"])])]),s("div",ve,[a[12]||(a[12]=s("div",{class:"col-3 full-height"}," Категории: ",-1)),s("div",ge,[n(X,{rows:t.value.categories,columns:B.value,flat:"",bordered:"",dense:"","hide-bottom":""},{"body-cell":p(e=>[n(Y,{item:e},{default:p(()=>{var o;return[e.col.name==="category"?(m(),y("div",fe,[n(z,{dense:"",flat:"",modelValue:e.row.category,"onUpdate:modelValue":r=>e.row.category=r,options:f.value,"option-label":"name",clearable:"",borderless:"","use-input":"",onFilter:D,onClear:E},null,8,["modelValue","onUpdate:modelValue","options"])])):w("",!0),e.col.name==="amount"?(m(),y("div",be,[n(_,{onChange:r=>P(r,e),flat:"",borderless:"",modelValue:e.row.amount,"onUpdate:modelValue":r=>e.row.amount=r,dense:"",type:"number"},null,8,["onChange","modelValue","onUpdate:modelValue"])])):w("",!0),e.col.name==="percent"?(m(),y(J,{key:2},[H(g((o=e.row)==null?void 0:o.percent)+"% ",1)],64)):w("",!0)]}),_:2},1032,["item"])]),_:1},8,["rows","columns"]),s("div",_e,[s("div",{class:"row justify-between col-6"},[s("p",{onClick:M,class:"cursor-pointer text-blue-9"}," Добавить... "),a[11]||(a[11]=s("p",null," Итого: ",-1))]),s("div",ye,[s("p",null,g(t.value.categories.reduce((e,o)=>e+(parseFloat(o.amount)||0),0)),1)]),s("div",we,[s("p",null,g((t.value.categories.reduce((e,o)=>e+(parseFloat(o.amount)||0),0)/t.value.sber_amountRub*100).toFixed(2))+"% ",1)])]),c.value.message?(m(),y("div",he,[s("div",Ve,g(c.value.message),1),s("div",Ce,g(c.value.difference),1)])):w("",!0)])]),n(K,{class:"q-mt-md",label:"Сохранить",type:"submit",color:"primary"})]),_:1})]),_:1})])]),_:1}))}};export{Ne as default};
